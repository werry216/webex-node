{"version":3,"sources":["handler.js"],"names":["checkForAndHandleErrors","action","meeting","correlationId","type","msg","messageType","errorType","RoapUtil","findError","handleError","mediaProperties","peerConnection","then","res","RoapCollection","deleteSessionSequence","seq","catch","err","LoggerProxy","logger","warn","ensureMeeting","compareRemoteRoapOffer","lastRoapMessage","currentRoapMessage","handleSessionStep","roap","session","locusUrl","sequenceId","OFFER","_OFFER_","GLARE_OFFER","remote","metricName","METRICS_OPERATIONAL_MEASURES","ROAP_GLARE_CONDITION","data","correlation_id","locus_id","split","pop","sequence","Metrics","sendOperationalMetric","info","state","RoapHandler","attrs","options","roapOk","roapAnswer","ROAP","ROAP_STATE","WAIT_TX_ANSWER","shouldHandleMedia","updatePeerConnection","answerSdps","locusId","locusSelfId","locusInfo","self","id","mediaId","sdps","audioMuted","isAudioMuted","videoMuted","isVideoMuted","error","ROAP_ANSWER_FAILURE","reason","message","stack","metadata","name","WAIT_TX_OK","setRemoteDescription","ERROR","GLARE","tieBreaker","log","step","ROAP_SIGNAL","GLARE_RESOLVED","perform","signal","prefix","RECEIVE_ROAP_MSG","execute","RX_","SEND_ROAP_MSG","local","TX_","SEND_ROAP_MSG_SUCCESS","getSessionSequence","ANSWER","RX_ANSWER","RECEIVE_CALL_LEAVE","deleteSession","RESET_ROAP_STATE","webex","meetings","meetingCollection","getByKey","handleAction","StatelessWebexPlugin"],"mappings":"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","sourcesContent":["/* no-param-reassign */\nimport {StatelessWebexPlugin} from '@webex/webex-core';\n\nimport LoggerProxy from '../common/logs/logger-proxy';\nimport {ROAP, _OFFER_, METRICS_OPERATIONAL_MEASURES} from '../constants';\nimport Metrics from '../metrics';\n\nimport RoapUtil from './util';\nimport RoapCollection from './collection';\n\n\nconst checkForAndHandleErrors = (action, meeting, correlationId) => {\n  if (action && action.type) {\n    if (action.msg && action.msg.messageType && action.msg.errorType) {\n      if (RoapUtil.findError(action.msg.messageType, action.msg.errorType, action.type)) {\n        RoapUtil.handleError(meeting.mediaProperties.peerConnection)\n          .then((res) => {\n            if (res) {\n              RoapCollection.deleteSessionSequence(correlationId, action.msg.seq);\n            }\n          })\n          .catch((err) => {\n            LoggerProxy.logger.warn(`Roap:handler#checkForAndHandleErrors --> Cannot reset the peer connection with error: ${err}`);\n          });\n\n        return true;\n      }\n    }\n    if (!RoapUtil.ensureMeeting(meeting, action.type)) {\n      return true;\n    }\n  }\n\n  return false;\n};\n\nconst compareRemoteRoapOffer = (lastRoapMessage, currentRoapMessage) => lastRoapMessage?.msg?.seq === currentRoapMessage.msg.seq;\n\nconst handleSessionStep = ({\n  roap, session, locusUrl, correlationId\n}) => {\n  const {seq: sequenceId, messageType} = roap.msg;\n\n  if (session.OFFER && messageType === _OFFER_) {\n    session.GLARE_OFFER = roap.msg;\n    session.GLARE_OFFER.remote = !!roap.remote;\n    const metricName = METRICS_OPERATIONAL_MEASURES.ROAP_GLARE_CONDITION;\n    const data = {\n      correlation_id: correlationId,\n      locus_id: locusUrl.split('/').pop(),\n      sequence: sequenceId\n    };\n\n    Metrics.sendOperationalMetric(metricName, data);\n\n    LoggerProxy.logger.warn(`Roap:handler#handleSessionStep --> Glare condition occurred with new mercury event, sequenceId: ${sequenceId}`);\n  }\n  else {\n    LoggerProxy.logger.info(`Roap:handler#handleSessionStep --> Save OFFER/ANSWER seq:${sequenceId} new mercury event ${messageType}local state: ${JSON.stringify(session.state.state, null, 2)}`);\n    session[messageType] = roap.msg;\n    session[messageType].remote = !!roap.remote;\n  }\n};\n\n/**\n * @class RoapHandler\n */\nexport default class RoapHandler extends StatelessWebexPlugin {\n  constructor(attrs, options, roapOk, roapAnswer) {\n    super({}, options);\n    this.attrs = attrs;\n    this.options = options;\n    this.roapOk = roapOk;\n    this.roapAnswer = roapAnswer;\n    this.lastRoapMessage = null;\n  }\n\n  /**\n   *\n   * @param {Object} session\n   * @param {Meeting} meeting\n   * @param {Object} action\n   * @returns {null}\n   */\n  perform(session, meeting, action) {\n    switch (session.state.state) {\n      // case ROAP.ROAP_STATE.INIT:\n      // case ROAP.ROAP_STATE.WAIT_RX_OFFER:\n      // case ROAP.ROAP_STATE.WAIT_RX_ANSWER:\n      // case ROAP.ROAP_STATE.WAIT_RX_OK:\n      case ROAP.ROAP_STATE.WAIT_TX_ANSWER:\n        // eslint-disable-next-line no-warning-comments\n        // TODO: sometime the you get an answer while you are creating an offer so SKIP\n        // Server will send the mercury event comes back\n        if (RoapUtil.shouldHandleMedia(meeting)) {\n          RoapUtil.updatePeerConnection(meeting, session)\n            .then((answerSdps) => {\n              this.roapAnswer({\n                locusId: meeting.locusId,\n                locusSelfId: meeting.locusInfo.self.id,\n                mediaId: meeting.mediaId,\n                sdps: answerSdps,\n                seq: session.OFFER.seq,\n                correlationId: meeting.correlationId,\n                audioMuted: meeting.isAudioMuted(),\n                videoMuted: meeting.isVideoMuted()\n              });\n            })\n            .catch((error) => {\n              const metricName = METRICS_OPERATIONAL_MEASURES.ROAP_ANSWER_FAILURE;\n              const data = {\n                correlation_id: meeting.correlationId,\n                locus_id: meeting.locusUrl.split('/').pop(),\n                reason: error.message,\n                stack: error.stack\n              };\n              const metadata = {\n                type: error.name\n              };\n\n              Metrics.sendOperationalMetric(metricName, data, metadata);\n              LoggerProxy.logger.error(`Roap:handler#perform --> Error occured during wait receive answer, continuing, ${error}`);\n            });\n        }\n        break;\n      case ROAP.ROAP_STATE.WAIT_TX_OK:\n        if (!RoapUtil.shouldHandleMedia(meeting)) {\n          RoapUtil.setRemoteDescription(meeting, session).then((res) => {\n            this.roapOk(res);\n          });\n        }\n        break;\n      // case ROAP.ROAP_STATE.IDLE_LOCAL_OFFER:\n      case ROAP.ROAP_STATE.ERROR:\n        LoggerProxy.logger.error(`Roap:handler#perform --> Roap State ERROR for session: ${session}`);\n        break;\n      case ROAP.ROAP_STATE.GLARE:\n        session.GLARE_OFFER.tieBreaker = session.GLARE_OFFER.tieBreaker || 0;\n        session.OFFER.tieBreaker = session.OFFER.tieBreaker || 0;\n        LoggerProxy.logger.warn('Roap:handler#perform --> Roap State resolved the GLARE condition.');\n        if (session.GLARE_OFFER.tieBreaker < session.OFFER.tieBreaker) {\n          // 2\n          LoggerProxy.logger.log('Roap:handler#perform --> Roap State local offer won after GLARE.');\n        }\n        else {\n          LoggerProxy.logger.log('Roap:handler#perform --> Roap State remote offer won after GLARE.');\n        }\n        session.state.step(ROAP.ROAP_SIGNAL.GLARE_RESOLVED, meeting, action);\n        this.perform(session, meeting);\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   *\n   * @param {String} signal\n   * @param {Object} session\n   * @param {Object} action\n   * @param {Meeting} meeting\n   * @param {String} prefix\n   * @returns {null}\n   */\n  execute(signal, session, action, meeting, prefix) {\n    if (session && session.state) {\n      handleSessionStep({\n        roap: action,\n        locusUrl: meeting.locusUrl,\n        correlationId: meeting.correlationId,\n        session\n      });\n      signal = ROAP.ROAP_SIGNAL[`${prefix}${action.msg.messageType}`];\n      session.state.step(signal, meeting, action);\n      this.perform(session, meeting, action);\n    }\n  }\n\n  /**\n   *\n   * @param {Object} session\n   * @param {Object} action\n   * @param {Meeting} meeting\n   * @param {String} correlationId\n   * @returns {Boolean}\n   */\n  handleAction(session, action, meeting, correlationId) {\n    let signal;\n\n    switch (action.type) {\n      case ROAP.RECEIVE_ROAP_MSG:\n        if (compareRemoteRoapOffer(this.lastRoapMessage, action)) {\n          LoggerProxy.logger.warn(`Roap:handler#handleAction --> duplicate roap offer from server: ${action.msg.seq}`); break;\n        }\n        else {\n          this.lastRoapMessage = action;\n          action.remote = true;\n        }\n\n        this.execute(signal, session, action, meeting, ROAP.RX_);\n        break;\n      case ROAP.SEND_ROAP_MSG:\n        action.local = true;\n        this.execute(signal, session, action, meeting, ROAP.TX_);\n        break;\n      case ROAP.SEND_ROAP_MSG_SUCCESS:\n        // This means we got and answer and waiting for 200 ok for /participants\n        if (RoapCollection.getSessionSequence(correlationId, action.seq).ANSWER) {\n          signal = ROAP.ROAP_SIGNAL.RX_ANSWER;\n          // NOTE: When server send back an answer via mercury the\n          // remote SDP is already saved sent and ok message is sent back\n          // We dont have to indicate the roapHandler about the RX_ANSWER via SEND_ROAP_MSG_SUCCESS\n          // RoapHandler.transition(signal, session, meeting);\n        }\n        break;\n      case ROAP.RECEIVE_CALL_LEAVE:\n        RoapCollection.deleteSession(correlationId);\n        LoggerProxy.logger.log(`Roap:handler#handleAction --> RECEIVE_CALL_LEAVE event captured, cleaning up the RoapHandler for correlationId: ${correlationId}`); break;\n      case ROAP.RESET_ROAP_STATE:\n        RoapCollection.deleteSessionSequence(correlationId, action.msg.seq);\n        LoggerProxy.logger.log(`Roap:handler#handleAction --> RESET_ROAP_STATE event captured, resetting the RoapHandler state based on sequenceId: ${action.msg.seq}`); break;\n      default:\n        return true;\n    }\n\n    return true;\n  }\n\n  /**\n   *\n   * @param {Object} action\n   * @returns {Boolean}\n   */\n  submit(action) {\n    const {correlationId} = action;\n    let {seq} = action;\n\n    if (!seq && action.msg) {\n      seq = action.msg.seq;\n    }\n    const session = RoapCollection.getSessionSequence(correlationId, seq);\n    const meeting = this.webex.meetings.meetingCollection.getByKey('correlationId', correlationId);\n\n    if (checkForAndHandleErrors(action, meeting, correlationId)) {\n      return true;\n    }\n\n    return this.handleAction(session, action, meeting, correlationId);\n  }\n}\n"]}