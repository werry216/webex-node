{"version":3,"sources":["one-flight.js"],"names":["W","M","WeakMappedMappedMap","flights","oneFlight","params","length","oneFlightDecorator","options","cacheFailures","cacheSuccesses","keyFactory","target","prop","descriptor","key","value","oneFlightExecutor","fn","innerKey","args","flight","get","catch","reason","delete","reject","then","result","set","prototype"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAMA;;AAEA;AACA,IAAMA,CAAC,mBAAP;AACA,IAAMC,CAAC,eAAP;AACA,IAAMC,mBAAmB,GAAG,gCAAKF,CAAL,EAAQC,CAAR,EAAWA,CAAX,CAA5B;AAEA,IAAME,OAAO,GAAG,IAAID,mBAAJ,EAAhB;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACe,SAASE,SAAT,GAA8B;AAAA,oCAARC,MAAQ;AAARA,IAAAA,MAAQ;AAAA;;AAC3C,MAAIA,MAAM,CAACC,MAAP,KAAkB,CAAtB,EAAyB;AACvB,WAAO,oBAAcC,kBAAd,EAAkC,IAAlC,EAAwCF,MAAxC,CAAP;AACD;;AAED,MAAMG,OAAO,GAAGH,MAAM,CAAC,CAAD,CAAN,IAAa,EAA7B;AAL2C,MAQzCI,aARyC,GAWvCD,OAXuC,CAQzCC,aARyC;AAAA,MASzCC,cATyC,GAWvCF,OAXuC,CASzCE,cATyC;AAAA,MAUzCC,UAVyC,GAWvCH,OAXuC,CAUzCG,UAVyC;AAa3C,SAAOJ,kBAAP;AAEA;AACF;AACA;AACA;AACA;AACA;AACA;;AACE,WAASA,kBAAT,CAA4BK,MAA5B,EAAoCC,IAApC,EAA0CC,UAA1C,EAAsD;AACpD,QAAMC,GAAG,GAAGF,IAAZ;AAEAC,IAAAA,UAAU,CAACE,KAAX,GAAmB,oBAAKF,UAAU,CAACE,KAAhB,EAAuB,SAASC,iBAAT,CAA2BC,EAA3B,EAAwC;AAAA;;AAChF,UAAIC,QAAQ,GAAGJ,GAAf;;AADgF,yCAANK,IAAM;AAANA,QAAAA,IAAM;AAAA;;AAGhF,UAAIT,UAAJ,EAAgB;AACdQ,QAAAA,QAAQ,aAAMA,QAAN,cAAkBR,UAAU,MAAV,SAAcS,IAAd,CAAlB,CAAR;AACD;AAED;;;AACA,UAAIC,MAAM,GAAGlB,OAAO,CAACmB,GAAR,CAAY,IAAZ,EAAkBV,MAAlB,EAA0BO,QAA1B,CAAb;;AAEA,UAAIE,MAAJ,EAAY;AACV,eAAOA,MAAP;AACD;;AAEDA,MAAAA,MAAM,GAAG,oBAAcH,EAAd,EAAkB,IAAlB,EAAwBE,IAAxB,CAAT;;AACA,UAAI,CAACX,aAAD,IAAkBY,MAAlB,IAA4BA,MAAM,CAACE,KAAvC,EAA8C;AAC5CF,QAAAA,MAAM,GAAGA,MAAM,CAACE,KAAP,CAAa,UAACC,MAAD,EAAY;AAChCrB,UAAAA,OAAO,CAACsB,MAAR,CAAe,KAAf,EAAqBb,MAArB,EAA6BO,QAA7B;AAEA,iBAAO,iBAAQO,MAAR,CAAeF,MAAf,CAAP;AACD,SAJQ,CAAT;AAKD;;AAED,UAAI,CAACd,cAAD,IAAmBW,MAAnB,IAA6BA,MAAM,CAACM,IAAxC,EAA8C;AAC5CN,QAAAA,MAAM,GAAGA,MAAM,CAACM,IAAP,CAAY,UAACC,MAAD,EAAY;AAC/BzB,UAAAA,OAAO,CAACsB,MAAR,CAAe,KAAf,EAAqBb,MAArB,EAA6BO,QAA7B;AAEA,iBAAOS,MAAP;AACD,SAJQ,CAAT;AAKD;;AAEDzB,MAAAA,OAAO,CAAC0B,GAAR,CAAY,IAAZ,EAAkBjB,MAAlB,EAA0BO,QAA1B,EAAoCE,MAApC;AAEA,aAAOA,MAAP;AACD,KAlCkB,CAAnB,CAHoD,CAuCpD;AACA;;AACA,QAAI,sBAAOT,MAAP,MAAkB,QAAlB,IAA8B,CAACA,MAAM,CAACkB,SAA1C,EAAqD;AACnDlB,MAAAA,MAAM,CAACC,IAAD,CAAN,GAAeC,UAAU,CAACE,KAA1B;AACD;;AAED,WAAOF,UAAP;AACD;AACF","sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {wrap} from 'lodash';\n\nimport make from './template-container';\n\n// Alias Map and WeakMap to get around a babel compiler bug\nconst W = WeakMap;\nconst M = Map;\nconst WeakMappedMappedMap = make(W, M, M);\n\nconst flights = new WeakMappedMappedMap();\n\n/**\n * @memberof Util\n * @param {Object} options\n * @param {Function} options.keyFactory\n * @param {boolean} options.cacheFailures\n * @param {boolean} options.cacheSuccesses\n * @returns {Function}\n */\nexport default function oneFlight(...params) {\n  if (params.length === 3) {\n    return Reflect.apply(oneFlightDecorator, null, params);\n  }\n\n  const options = params[0] || {};\n\n  const {\n    cacheFailures,\n    cacheSuccesses,\n    keyFactory\n  } = options;\n\n  return oneFlightDecorator;\n\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n  function oneFlightDecorator(target, prop, descriptor) {\n    const key = prop;\n\n    descriptor.value = wrap(descriptor.value, function oneFlightExecutor(fn, ...args) {\n      let innerKey = key;\n\n      if (keyFactory) {\n        innerKey = `${innerKey}_${keyFactory(...args)}`;\n      }\n\n      /* eslint no-invalid-this: [0] */\n      let flight = flights.get(this, target, innerKey);\n\n      if (flight) {\n        return flight;\n      }\n\n      flight = Reflect.apply(fn, this, args);\n      if (!cacheFailures && flight && flight.catch) {\n        flight = flight.catch((reason) => {\n          flights.delete(this, target, innerKey);\n\n          return Promise.reject(reason);\n        });\n      }\n\n      if (!cacheSuccesses && flight && flight.then) {\n        flight = flight.then((result) => {\n          flights.delete(this, target, innerKey);\n\n          return result;\n        });\n      }\n\n      flights.set(this, target, innerKey, flight);\n\n      return flight;\n    });\n\n    // This *should* make decorators compatible with AmpersandState class\n    // definitions\n    if (typeof target === 'object' && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}\n"]}