{"version":3,"sources":["device-url.js"],"names":["DeviceUrlInterceptor","options","headers","service","uri","webex","internal","device","services","url","CISCO_DEVICE_URL","resolve","waitForService","then","getServiceFromUrl","serviceName","name","invalidServices","includes","catch","error","message","match","reject","Interceptor"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIA;;AAGA;;;;;;AAEA;AACA;AACA;IACqBA,oB;;;;;;;;;;;;;AASnB;AACF;AACA;AACA;AACA;AACE,uBAAUC,OAAV,EAAmB;AAAA,UACVC,OADU,GACeD,OADf,CACVC,OADU;AAAA,UACDC,OADC,GACeF,OADf,CACDE,OADC;AAAA,UACQC,GADR,GACeH,OADf,CACQG,GADR;AAAA,iCAEU,KAAKC,KAAL,CAAWC,QAFrB;AAAA,UAEVC,MAFU,wBAEVA,MAFU;AAAA,UAEFC,QAFE,wBAEFA,QAFE,EAIjB;;AACA,UACE,CAACD,MAAM,CAACE,GAAR,IACCP,OAAO,IAAIQ,+BAAoBR,OAA/B,IAA0C,CAACA,OAAO,CAACQ,2BAAD,CAFrD,EAGE;AACA,eAAO,iBAAQC,OAAR,CAAgBV,OAAhB,CAAP;AACD,OAVgB,CAYjB;;;AACA,aAAOO,QAAQ,CAACI,cAAT,CAAwB;AAACT,QAAAA,OAAO,EAAPA,OAAD;AAAUM,QAAAA,GAAG,EAAEL;AAAf,OAAxB,EACJS,IADI,CACC,UAACJ,GAAD,EAAS;AACb;AADa,mBAEeD,QAAQ,CAACM,iBAAT,CAA2BL,GAA3B,KAAmC,EAFlD;AAAA,YAEAM,WAFA,QAENC,IAFM;;AAGb,YAAMC,eAAe,GAAG,CAAC,UAAD,EAAa,OAAb,EAAsB,MAAtB,CAAxB,CAHa,CAKb;AACA;;AACA,YAAIF,WAAW,IAAI,CAACE,eAAe,CAACC,QAAhB,CAAyBH,WAAzB,CAApB,EAA2D;AACzD,6BAAId,OAAJ,qBAAyBS,2BAAzB,SAA+CH,MAAM,CAACE,GAAtD;AACD;;AAED,eAAOR,OAAP;AACD,OAbI,EAcJkB,KAdI,CAcE,UAACC,KAAD,EAAW;AAChB;AACA,YAAIA,KAAK,CAACC,OAAN,CAAcC,KAAd,CAAoB,6BAApB,CAAJ,EAAwD;AACtD,iBAAOrB,OAAP;AACD;;AAED,eAAO,iBAAQsB,MAAR,CAAeH,KAAf,CAAP;AACD,OArBI,CAAP;AAsBD;;;;AAhDD;AACF;AACA;AACE,sBAAgB;AACd;AACA,aAAO,IAAIpB,oBAAJ,CAAyB;AAACK,QAAAA,KAAK,EAAE;AAAR,OAAzB,CAAP;AACD;;;EAP+CmB,qB","sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {Interceptor} from '@webex/http-core';\nimport {set} from 'lodash';\n\nimport {CISCO_DEVICE_URL} from '../constants';\n\n/**\n  * Adds 'cisco-device-url' header, as appropriate, to requests\n  */\nexport default class DeviceUrlInterceptor extends Interceptor {\n  /**\n   * @returns {DeviceUrlInterceptor}\n   */\n  static create() {\n    /* eslint no-invalid-this: [0] */\n    return new DeviceUrlInterceptor({webex: this});\n  }\n\n  /**\n   * @see Interceptor#onRequest\n   * @param {Object} options\n   * @returns {Object}\n   */\n  onRequest(options) {\n    const {headers, service, uri} = options;\n    const {device, services} = this.webex.internal;\n\n    // Check if header is already set before moving forward\n    if (\n      !device.url ||\n      (headers && CISCO_DEVICE_URL in headers && !headers[CISCO_DEVICE_URL])\n    ) {\n      return Promise.resolve(options);\n    }\n\n    // Wait for catalog and service to be defined.\n    return services.waitForService({service, url: uri})\n      .then((url) => {\n        // Grab the service name with the url returned from waitForService\n        const {name: serviceName} = services.getServiceFromUrl(url) || {};\n        const invalidServices = ['idbroker', 'oauth', 'saml'];\n\n        // Check if service is not one of the invalid services\n        // Assign the url to the device header\n        if (serviceName && !invalidServices.includes(serviceName)) {\n          set(options, `headers['${CISCO_DEVICE_URL}']`, device.url);\n        }\n\n        return options;\n      })\n      .catch((error) => {\n        // Validate that the error came from getServiceFromUrl\n        if (error.message.match(/was not found after waiting/)) {\n          return options;\n        }\n\n        return Promise.reject(error);\n      });\n  }\n}\n"]}