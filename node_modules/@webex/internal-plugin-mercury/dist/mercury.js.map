{"version":3,"sources":["mercury.js"],"names":["normalReconnectReasons","Mercury","WebexPlugin","extend","namespace","session","connected","default","type","connecting","socket","localClusterServiceUrls","derived","listening","deps","fn","connect","webSocketUrl","logger","info","resolve","webex","internal","device","registered","register","then","_connectWithBackoff","disconnect","backoffCall","abort","removeAllListeners","once","close","listen","stopListening","processRegistrationStatusEvent","message","_applyOverrides","event","headers","headerKeys","forEach","keyPath","_prepareUrl","feature","getFeature","haMessagingEnabled","services","convertUrlToPriorityHostUrl","wsUrl","webSharedMercury","url","parse","query","outboundWireFormat","bufferStates","aliasHttpStatus","mercuryRegistrationStatus","isRegistrationRefreshEnabled","multipleConnections","format","_attemptConnection","socketUrl","callback","Socket","attemptWSUrl","on","_onclose","_onmessage","args","_emit","all","credentials","getUserToken","token","msg","reject","Error","options","forceCloseDelay","config","pingInterval","pongTimeout","toString","trackingId","sessionId","defaultMercuryOptions","open","metrics","submitClientMetrics","fields","success","tags","action","refresh","catch","reason","code","getNumRetries","retries","UnknownResponse","NotAuthorized","force","BadRequest","Forbidden","warn","ConnectionError","error","markFailedUrl","call","onComplete","err","undefined","backoff","setStrategy","ExponentialStrategy","initialDelay","backoffTimeReset","maxDelay","backoffTimeMax","maxRetries","failAfter","number","delay","Math","min","strategy_","nextBackoffDelay_","process","env","NODE_ENV","debug","stack","start","trigger","_getEventHandlers","eventType","split","name","handlers","handlerName","push","toLowerCase","unset","_reconnect","includes","envelope","data","ENABLE_MERCURY_LOGGING","reduce","promise","handler","oneFlight"],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport url from 'url';\n\nimport {WebexPlugin} from '@webex/webex-core';\nimport {deprecated, oneFlight} from '@webex/common';\nimport {camelCase, get, set} from 'lodash';\nimport backoff from 'backoff';\n\nimport Socket from './socket';\nimport {\n  BadRequest,\n  Forbidden,\n  NotAuthorized,\n  UnknownResponse,\n  ConnectionError\n  // NotFound\n} from './errors';\n\nconst normalReconnectReasons = [\n  'idle',\n  'done (forced)',\n  'pong not received',\n  'pong mismatch'\n];\n\nconst Mercury = WebexPlugin.extend({\n  namespace: 'Mercury',\n\n  session: {\n    connected: {\n      default: false,\n      type: 'boolean'\n    },\n    connecting: {\n      default: false,\n      type: 'boolean'\n    },\n    socket: 'object',\n    localClusterServiceUrls: 'object'\n  },\n\n  derived: {\n    listening: {\n      deps: ['connected'],\n      fn() {\n        return this.connected;\n      }\n    }\n  },\n\n  @oneFlight\n  connect(webSocketUrl) {\n    if (this.connected) {\n      this.logger.info('mercury: already connected, will not connect again');\n\n      return Promise.resolve();\n    }\n\n    this.connecting = true;\n\n    return Promise.resolve(this.webex.internal.device.registered || this.webex.internal.device.register())\n      .then(() => {\n        this.logger.info('mercury: connecting');\n\n        return this._connectWithBackoff(webSocketUrl);\n      });\n  },\n\n  @oneFlight\n  disconnect() {\n    return new Promise((resolve) => {\n      if (this.backoffCall) {\n        this.logger.info('mercury: aborting connection');\n        this.backoffCall.abort();\n      }\n\n      if (this.socket) {\n        this.socket.removeAllListeners('message');\n        this.once('offline', resolve);\n        this.socket.close();\n\n        return;\n      }\n\n      resolve();\n    });\n  },\n\n  @deprecated('Mercury#listen(): Use Mercury#connect() instead')\n  listen() {\n    /* eslint no-invalid-this: [0] */\n    return this.connect();\n  },\n\n  @deprecated('Mercury#stopListening(): Use Mercury#disconnect() instead')\n  stopListening() {\n    /* eslint no-invalid-this: [0] */\n    return this.disconnect();\n  },\n\n  processRegistrationStatusEvent(message) {\n    this.localClusterServiceUrls = message.localClusterServiceUrls;\n  },\n\n  _applyOverrides(event) {\n    if (!event || !event.headers) {\n      return;\n    }\n    const headerKeys = Object.keys(event.headers);\n\n    headerKeys.forEach((keyPath) => {\n      set(event, keyPath, event.headers[keyPath]);\n    });\n  },\n\n  _prepareUrl(webSocketUrl) {\n    if (!webSocketUrl) {\n      webSocketUrl = this.webex.internal.device.webSocketUrl;\n    }\n\n    return this.webex.internal.feature.getFeature('developer', 'web-high-availability')\n      .then((haMessagingEnabled) => {\n        if (haMessagingEnabled) {\n          return this.webex.internal.services.convertUrlToPriorityHostUrl(webSocketUrl);\n        }\n\n        return webSocketUrl;\n      })\n      .then((wsUrl) => {\n        webSocketUrl = wsUrl;\n      })\n      .then(() => this.webex.internal.feature.getFeature('developer', 'web-shared-mercury'))\n      .then((webSharedMercury) => {\n        webSocketUrl = url.parse(webSocketUrl, true);\n        Object.assign(webSocketUrl.query, {\n          outboundWireFormat: 'text',\n          bufferStates: true,\n          aliasHttpStatus: true\n        });\n\n        if (webSharedMercury) {\n          Object.assign(webSocketUrl.query, {\n            mercuryRegistrationStatus: true,\n            isRegistrationRefreshEnabled: true\n          });\n          Reflect.deleteProperty(webSocketUrl.query, 'bufferStates');\n        }\n\n        if (get(this, 'webex.config.device.ephemeral', false)) {\n          webSocketUrl.query.multipleConnections = true;\n        }\n\n        return url.format(webSocketUrl);\n      });\n  },\n\n  _attemptConnection(socketUrl, callback) {\n    const socket = new Socket();\n    let attemptWSUrl;\n\n    socket.on('close', (...args) => this._onclose(...args));\n    socket.on('message', (...args) => this._onmessage(...args));\n    socket.on('sequence-mismatch', (...args) => this._emit('sequence-mismatch', ...args));\n\n    Promise.all([this._prepareUrl(socketUrl), this.webex.credentials.getUserToken()])\n      .then(([webSocketUrl, token]) => {\n        if (!this.backoffCall) {\n          const msg = 'mercury: prevent socket open when backoffCall no longer defined';\n\n          this.logger.info(msg);\n\n          return Promise.reject(new Error(msg));\n        }\n\n        attemptWSUrl = webSocketUrl;\n\n        let options = {\n          forceCloseDelay: this.config.forceCloseDelay,\n          pingInterval: this.config.pingInterval,\n          pongTimeout: this.config.pongTimeout,\n          token: token.toString(),\n          trackingId: `${this.webex.sessionId}_${Date.now()}`,\n          logger: this.logger\n        };\n\n        // if the consumer has supplied request options use them\n        if (this.webex.config.defaultMercuryOptions) {\n          this.logger.info('mercury: setting custom options');\n          options = {...options, ...this.webex.config.defaultMercuryOptions};\n        }\n\n        // Set the socket before opening it. This allows a disconnect() to close\n        // the socket if it is in the process of being opened.\n        this.socket = socket;\n\n        return socket.open(webSocketUrl, options);\n      })\n      .then(() => {\n        this.webex.internal.metrics.submitClientMetrics('web-ha-mercury', {\n          fields: {\n            success: true\n          },\n          tags: {\n            action: 'connected',\n            url: attemptWSUrl\n          }\n        });\n        callback();\n\n        return this.webex.internal.feature.getFeature('developer', 'web-high-availability')\n          .then((haMessagingEnabled) => {\n            if (haMessagingEnabled) {\n              return this.webex.internal.device.refresh();\n            }\n\n            return Promise.resolve();\n          });\n      })\n      .catch((reason) => {\n        // Suppress connection errors that appear to be network related. This\n        // may end up suppressing metrics during outages, but we might not care\n        // (especially since many of our outages happen in a way that client\n        // metrics can't be trusted).\n        if (reason.code !== 1006 && this.backoffCall && this.backoffCall.getNumRetries() > 0) {\n          this._emit('connection_failed', reason, {retries: this.backoffCall.getNumRetries()});\n        }\n        this.logger.info('mercury: connection attempt failed', reason);\n        // UnknownResponse is produced by IE for any 4XXX; treated it like a bad\n        // web socket url and let WDM handle the token checking\n        if (reason instanceof UnknownResponse) {\n          this.logger.info('mercury: received unknown response code, refreshing device registration');\n\n          return this.webex.internal.device.refresh()\n            .then(() => callback(reason));\n        }\n        // NotAuthorized implies expired token\n        if (reason instanceof NotAuthorized) {\n          this.logger.info('mercury: received authorization error, reauthorizing');\n\n          return this.webex.credentials.refresh({force: true})\n            .then(() => callback(reason));\n        }\n        // // NotFound implies expired web socket url\n        // else if (reason instanceof NotFound) {\n        //   this.logger.info(`mercury: received not found error, refreshing device registration`);\n        //   return this.webex.internal.device.refresh()\n        //     .then(() => callback(reason));\n        // }\n        // BadRequest implies current credentials are for a Service Account\n        // Forbidden implies current user is not entitle for Webex\n        if (reason instanceof BadRequest || reason instanceof Forbidden) {\n          this.logger.warn('mercury: received unrecoverable response from mercury');\n          this.backoffCall.abort();\n\n          return callback(reason);\n        }\n        if (reason instanceof ConnectionError) {\n          return this.webex.internal.feature.getFeature('developer', 'web-high-availability')\n            .then((haMessagingEnabled) => {\n              if (haMessagingEnabled) {\n                this.logger.info('mercury: received a generic connection error, will try to connect to another datacenter');\n                this.webex.internal.metrics.submitClientMetrics('web-ha-mercury', {\n                  fields: {\n                    success: false\n                  },\n                  tags: {\n                    action: 'failed',\n                    error: reason.message,\n                    url: attemptWSUrl\n                  }\n                });\n\n                return this.webex.internal.services.markFailedUrl(attemptWSUrl);\n              }\n\n              return null;\n            })\n            .then(() => callback(reason));\n        }\n\n        return callback(reason);\n      })\n      .catch((reason) => {\n        this.logger.error('mercury: failed to handle connection failure', reason);\n        callback(reason);\n      });\n  },\n\n  _connectWithBackoff(webSocketUrl) {\n    return new Promise((resolve, reject) => {\n      // eslint gets confused about whether or not call is actually used\n      // eslint-disable-next-line prefer-const\n      let call;\n      const onComplete = (err) => {\n        this.connecting = false;\n\n        this.backoffCall = undefined;\n        if (err) {\n          this.logger.info(`mercury: failed to connect after ${call.getNumRetries()} retries; log statement about next retry was inaccurate; ${err}`);\n\n          return reject(err);\n        }\n        this.connected = true;\n        this._emit('online');\n\n        return resolve();\n      };\n\n      // eslint-disable-next-line prefer-reflect\n      call = backoff.call((callback) => {\n        this.logger.info(`mercury: executing connection attempt ${call.getNumRetries()}`);\n        this._attemptConnection(webSocketUrl, callback);\n      }, onComplete);\n\n      call.setStrategy(new backoff.ExponentialStrategy({\n        initialDelay: this.config.backoffTimeReset,\n        maxDelay: this.config.backoffTimeMax\n      }));\n\n      if (this.config.maxRetries) {\n        call.failAfter(this.config.maxRetries);\n      }\n\n      call.on('abort', () => {\n        this.logger.info('mercury: connection aborted');\n        reject(new Error('Mercury Connection Aborted'));\n      });\n\n      call.on('callback', (err) => {\n        if (err) {\n          const number = call.getNumRetries();\n          const delay = Math.min(call.strategy_.nextBackoffDelay_, this.config.backoffTimeMax);\n\n          this.logger.info(`mercury: failed to connect; attempting retry ${number + 1} in ${delay} ms`);\n          /* istanbul ignore if */\n          if (process.env.NODE_ENV === 'development') {\n            this.logger.debug('mercury: ', err, err.stack);\n          }\n\n          return;\n        }\n        this.logger.info('mercury: connected');\n      });\n\n      call.start();\n\n      this.backoffCall = call;\n    });\n  },\n\n  _emit(...args) {\n    try {\n      this.trigger(...args);\n    }\n    catch (error) {\n      this.logger.error('mercury: error occurred in event handler', error);\n    }\n  },\n\n  _getEventHandlers(eventType) {\n    const [namespace, name] = eventType.split('.');\n    const handlers = [];\n\n    if (!this.webex[namespace] && !this.webex.internal[namespace]) {\n      return handlers;\n    }\n\n    const handlerName = camelCase(`process_${name}_event`);\n\n    if ((this.webex[namespace] || this.webex.internal[namespace])[handlerName]) {\n      handlers.push({\n        name: handlerName,\n        namespace\n      });\n    }\n\n    return handlers;\n  },\n\n  _onclose(event) {\n    // I don't see any way to avoid the complexity or statement count in here.\n    /* eslint complexity: [0] */\n\n    try {\n      const reason = event.reason && event.reason.toLowerCase();\n      const socketUrl = this.socket.url;\n\n      this.socket.removeAllListeners();\n      this.unset('socket');\n      this.connected = false;\n      this._emit('offline', event);\n\n      switch (event.code) {\n        case 1003:\n        // metric: disconnect\n          this.logger.info(`mercury: Mercury service rejected last message; will not reconnect: ${event.reason}`);\n          this._emit('offline.permanent', event);\n          break;\n        case 4000:\n          // metric: disconnect\n          this.logger.info('mercury: socket replaced; will not reconnect');\n          this._emit('offline.replaced', event);\n          break;\n        case 1001:\n        case 1005:\n        case 1006:\n        case 1011:\n          this.logger.info('mercury: socket disconnected; reconnecting');\n          this._emit('offline.transient', event);\n          this._reconnect(socketUrl);\n          // metric: disconnect\n          // if (code == 1011 && reason !== ping error) metric: unexpected disconnect\n          break;\n        case 1000:\n          if (normalReconnectReasons.includes(reason)) {\n            this.logger.info('mercury: socket disconnected; reconnecting');\n            this._emit('offline.transient', event);\n            this._reconnect(socketUrl);\n            // metric: disconnect\n            // if (reason === done forced) metric: force closure\n          }\n          else {\n            this.logger.info('mercury: socket disconnected; will not reconnect');\n            this._emit('offline.permanent', event);\n          }\n          break;\n        default:\n          this.logger.info('mercury: socket disconnected unexpectedly; will not reconnect');\n          // unexpected disconnect\n          this._emit('offline.permanent', event);\n      }\n    }\n    catch (error) {\n      this.logger.error('mercury: error occurred in close handler', error);\n    }\n  },\n\n  _onmessage(event) {\n    const envelope = event.data;\n\n    if (process.env.ENABLE_MERCURY_LOGGING) {\n      this.logger.debug('mercury: message envelope: ', envelope);\n    }\n\n    const {data} = envelope;\n\n    this._applyOverrides(data);\n\n    return this._getEventHandlers(data.eventType)\n      .reduce((promise, handler) => promise.then(() => {\n        const {namespace, name} = handler;\n\n        return new Promise((resolve) => resolve((this.webex[namespace] || this.webex.internal[namespace])[name](data)))\n          .catch((reason) => this.logger.error(`mercury: error occurred in autowired event handler for ${data.eventType}`, reason));\n      }), Promise.resolve())\n      .then(() => {\n        this._emit('event', event.data);\n        const [namespace] = data.eventType.split('.');\n\n        if (namespace === data.eventType) {\n          this._emit(`event:${namespace}`, envelope);\n        }\n        else {\n          this._emit(`event:${namespace}`, envelope);\n          this._emit(`event:${data.eventType}`, envelope);\n        }\n      })\n      .catch((reason) => {\n        this.logger.error('mercury: error occurred processing socket message', reason);\n      });\n  },\n\n  _reconnect(webSocketUrl) {\n    this.logger.info('mercury: reconnecting');\n\n    return this.connect(webSocketUrl);\n  }\n});\n\nexport default Mercury;\n"]}