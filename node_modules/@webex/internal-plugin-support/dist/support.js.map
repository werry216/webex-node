{"version":3,"sources":["support.js"],"names":["Support","WebexPlugin","extend","namespace","getFeedbackUrl","options","request","method","api","resource","body","appVersion","config","appType","feedbackId","uuid","v4","languageCode","then","res","url","getSupportUrl","webex","qs","submitLogs","metadata","logs","metadataArray","_constructFileMetadata","logger","sdkBuffer","clientBuffer","buffer","formatLogs","filename","locusId","callStart","sessionId","userId","credentials","getUserToken","catch","getClientToken","token","headers","authorization","toString","initalOpts","service","finalOpts","file","shouldAttemptReauth","phases","initialize","upload","$uri","session","tempURL","finalize","$body","logFilename","data","internal","device","map","key","value","filter","entry","Boolean","push","orgId"],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {WebexPlugin} from '@webex/webex-core';\nimport {defaults} from 'lodash';\nimport uuid from 'uuid';\n\nconst Support = WebexPlugin.extend({\n  namespace: 'Support',\n\n  getFeedbackUrl(options) {\n    options = options || {};\n\n    return this.request({\n      method: 'POST',\n      api: 'conversation',\n      resource: 'users/deskFeedbackUrl',\n      body: defaults(options, {\n        appVersion: this.config.appVersion,\n        appType: this.config.appType,\n        feedbackId: options.feedbackId || uuid.v4(),\n        languageCode: this.config.languageCode\n      })\n    })\n      .then((res) => res.body.url);\n  },\n\n  getSupportUrl() {\n    return this.webex.request({\n      method: 'GET',\n      api: 'conversation',\n      resource: 'users/deskSupportUrl',\n      qs: {\n        languageCode: this.config.languageCode\n      }\n    })\n      .then((res) => res.body.url);\n  },\n\n  submitLogs(metadata, logs) {\n    const metadataArray = this._constructFileMetadata(metadata);\n\n    // this is really testing that Ampersand is fully ready.  once it's ready, these exist\n    if (!logs && this.webex.logger.sdkBuffer && this.webex.logger.clientBuffer && this.webex.logger.buffer) {\n      logs = this.webex.logger.formatLogs();\n    }\n\n    let filename;\n\n    if (metadata.locusId && metadata.callStart) {\n      filename = `${metadata.locusId}_${metadata.callStart}.txt`;\n    }\n    else {\n      filename = `${this.webex.sessionId}.txt`;\n    }\n\n    let userId;\n\n    return this.webex.credentials.getUserToken()\n      .catch(() => this.webex.credentials.getClientToken())\n      .then(async (token) => {\n        const headers = {authorization: token.toString()};\n\n        const initalOpts = {\n          service: 'clientLogs',\n          resource: 'logs/urls'\n        };\n\n        const finalOpts = {\n          service: 'clientLogs',\n          resource: 'logs/meta'\n        };\n\n        const options = defaults(initalOpts, {\n          file: logs,\n          shouldAttemptReauth: false,\n          headers,\n          phases: {\n            initialize: {\n              body: {\n                file: filename\n              }\n            },\n            upload: {\n              $uri: (session) => session.tempURL\n            },\n            finalize: defaults(finalOpts, {\n              $body: (session) => {\n                userId = session.userId;\n\n                return {\n                  filename: session.logFilename,\n                  data: metadataArray,\n                  userId: this.webex.internal.device.userId || session.userId\n                };\n              }\n            })\n          }\n        });\n\n        return this.webex.upload(options);\n      })\n      .then((body) => {\n        if (userId && !body.userId) {\n          body.userId = userId;\n        }\n\n        return body;\n      });\n  },\n\n  _constructFileMetadata(metadata) {\n    const metadataArray = [\n      'locusId',\n      'callStart',\n      'feedbackId',\n      'correlationId',\n      'meetingId'\n    ].map((key) => {\n      if (metadata[key]) {\n        return {\n          key,\n          value: metadata[key]\n        };\n      }\n\n      return null;\n    })\n      .filter((entry) => Boolean(entry));\n\n    if (this.webex.sessionId) {\n      metadataArray.push({\n        key: 'trackingId',\n        value: this.webex.sessionId\n      });\n    }\n\n    if (this.webex.internal.device.userId) {\n      metadataArray.push({\n        key: 'userId',\n        value: this.webex.internal.device.userId\n      });\n    }\n\n    if (this.webex.internal.device.orgId) {\n      metadataArray.push({\n        key: 'orgId',\n        value: this.webex.internal.device.orgId\n      });\n    }\n\n    return metadataArray;\n  }\n});\n\nexport default Support;\n"]}