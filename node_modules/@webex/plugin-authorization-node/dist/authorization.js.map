{"version":3,"sources":["authorization.js"],"names":["Authorization","WebexPlugin","extend","derived","isAuthenticating","deps","fn","isAuthorizing","session","default","type","namespace","logout","options","webex","request","method","uri","config","logoutUrl","body","token","cisService","service","requestAuthorizationCodeGrant","logger","info","code","reject","Error","tokenUrl","form","grant_type","redirect_uri","self_contained_token","auth","user","client_id","pass","client_secret","sendImmediately","shouldRefreshAccessToken","then","res","credentials","set","supertoken","catch","statusCode","ErrorConstructor","grantErrors","select","error","_res","requestAccessTokenFromJwt","jwt","hydraUri","internal","services","get","slice","process","env","HYDRA_SERVICE_URL","headers","authorization","access_token","token_type","expires_in","expiresIn","initServiceCatalogs","oneFlight"],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\n/* eslint camelcase: [0] */\n\nimport {oneFlight, whileInFlight} from '@webex/common';\nimport {grantErrors, WebexPlugin} from '@webex/webex-core';\n\n/**\n * NodeJS support for OAuth2\n * @class\n * @name AuthorizationNode\n */\nconst Authorization = WebexPlugin.extend({\n  derived: {\n    /**\n     * Alias of {@link AuthorizationNode#isAuthorizing}\n     * @instance\n     * @memberof AuthorizationNode\n     * @type {boolean}\n     */\n    isAuthenticating: {\n      deps: ['isAuthorizing'],\n      fn() {\n        return this.isAuthorizing;\n      }\n    }\n  },\n\n  session: {\n    /**\n     * Indicates if an Authorization Code exchange is inflight\n     * @instance\n     * @memberof AuthorizationNode\n     * @type {boolean}\n     */\n    isAuthorizing: {\n      default: false,\n      type: 'boolean'\n    }\n  },\n\n  namespace: 'Credentials',\n\n  logout(options = {}) {\n    this.webex.request({\n      method: 'POST',\n      uri: this.config.logoutUrl,\n      body: {\n        token: options.token,\n        cisService: this.config.service\n      }\n    });\n  },\n\n  @whileInFlight('isAuthorizing')\n  @oneFlight\n  /**\n   * Exchanges an authorization code for an access token\n   * @instance\n   * @memberof AuthorizationNode\n   * @param {Object} options\n   * @param {Object} options.code\n   * @returns {Promise}\n   */\n  requestAuthorizationCodeGrant(options = {}) {\n    this.logger.info('credentials: requesting authorization code grant');\n\n    if (!options.code) {\n      return Promise.reject(new Error('`options.code` is required'));\n    }\n\n    return this.webex.request({\n      method: 'POST',\n      uri: this.config.tokenUrl,\n      form: {\n        grant_type: 'authorization_code',\n        redirect_uri: this.config.redirect_uri,\n        code: options.code,\n        self_contained_token: true\n      },\n      auth: {\n        user: this.config.client_id,\n        pass: this.config.client_secret,\n        sendImmediately: true\n      },\n      shouldRefreshAccessToken: false\n    })\n      .then((res) => {\n        this.webex.credentials.set({supertoken: res.body});\n      })\n      .catch((res) => {\n        if (res.statusCode !== 400) {\n          return Promise.reject(res);\n        }\n\n        const ErrorConstructor = grantErrors.select(res.body.error);\n\n        return Promise.reject(new ErrorConstructor(res._res || res));\n      });\n  },\n\n  @oneFlight\n  /**\n   * Requests a Webex access token for a user already authenticated into\n   * your product.\n   *\n   * Note: You'll need to supply a jwtRefreshCallback of the form\n   * `Promise<jwt> = jwtRefreshCallback(webex)` for automatic token refresh to\n   * work.\n   *\n   * @instance\n   * @memberof AuthorizationNode\n   * @param {Object} options\n   * @param {Object} options.jwt This is a jwt generated by your backend that\n   * identifies a user in your system\n   * @returns {Promise}\n   */\n  requestAccessTokenFromJwt({jwt}) {\n    let hydraUri = this.webex.internal.services.get('hydra', true);\n\n    if (hydraUri && hydraUri.slice(-1) !== '/') {\n      // add a `/` to hydra's uri from the services catalog so that\n      // it matches the current env service format.\n      hydraUri += '/';\n    }\n\n    hydraUri = hydraUri ||\n      process.env.HYDRA_SERVICE_URL ||\n      'https://api.ciscospark.com/v1/';\n\n    return this.webex.request({\n      method: 'POST',\n      uri: `${hydraUri}jwt/login`,\n      headers: {\n        authorization: jwt\n      }\n    })\n      .then(({body}) => ({\n        access_token: body.token,\n        token_type: 'Bearer',\n        expires_in: body.expiresIn\n      }))\n      .then((token) => {\n        this.webex.credentials.set({\n          supertoken: token\n        });\n      })\n      .then(() => this.webex.internal.services.initServiceCatalogs());\n  }\n});\n\nexport default Authorization;\n"]}