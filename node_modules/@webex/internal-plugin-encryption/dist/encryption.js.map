{"version":3,"sources":["encryption.js"],"names":["Encryption","WebexPlugin","extend","children","kms","KMS","namespace","processKmsMessageEvent","event","decryptBinary","scr","buffer","then","b","length","byteLength","reject","Error","decrypt","decryptScr","key","cipherScr","options","getKey","k","SCR","fromJWE","jwk","decryptText","ciphertext","jose","JWE","createDecrypt","result","plaintext","toString","download","loc","shunt","EventEmitter","promise","_fetchDownloadUrl","uri","method","responseType","ret","request","res","body","logger","info","process","env","NODE_ENV","includes","resolve","inputBody","endpoints","endpointUrl","url","parse","protocol","pathname","format","allow","params","warn","encryptBinary","file","create","encrypt","ensureBuffer","cdata","encryptScr","toJWE","encryptText","createEncrypt","config","joseOptions","header","alg","reference","final","onBehalfOf","asKey","storageKey","unboundedStorage","get","keyString","JSON","keyObject","catch","fetchKey","put","replacer","v","json","toJSON"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AAEA;;AACA;;;;;;AAEA,IAAMA,UAAU,GAAGC,uBAAYC,MAAZ,CAAmB;AACpCC,EAAAA,QAAQ,EAAE;AACRC,IAAAA,GAAG,EAAEC;AADG,GAD0B;AAKpCC,EAAAA,SAAS,EAAE,YALyB;AAOpCC,EAAAA,sBAPoC,kCAObC,KAPa,EAON;AAC5B,WAAO,KAAKJ,GAAL,CAASG,sBAAT,CAAgCC,KAAhC,CAAP;AACD,GATmC;AAWpCC,EAAAA,aAXoC,yBAWtBC,GAXsB,EAWjBC,MAXiB,EAWT;AACzB,WAAO,2BAAaA,MAAb,EACJC,IADI,CACC,UAACC,CAAD,EAAO;AACX;AACA,UAAIF,MAAM,CAACG,MAAP,KAAkB,CAAlB,IAAuBH,MAAM,CAACI,UAAP,KAAsB,CAAjD,EAAoD;AAClD,eAAO,iBAAQC,MAAR,CAAe,IAAIC,KAAJ,CAAU,yCAAV,CAAf,CAAP;AACD;;AAED,aAAOP,GAAG,CAACQ,OAAJ,CAAYL,CAAZ,CAAP;AACD,KARI,CAAP;AASD,GArBmC;;AAuBpC;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACEM,EAAAA,UAhCoC,sBAgCzBC,GAhCyB,EAgCpBC,SAhCoB,EAgCTC,OAhCS,EAgCA;AAClC,WAAO,KAAKC,MAAL,CAAYH,GAAZ,EAAiBE,OAAjB,EACJV,IADI,CACC,UAACY,CAAD;AAAA,aAAOC,iBAAIC,OAAJ,CAAYF,CAAC,CAACG,GAAd,EAAmBN,SAAnB,CAAP;AAAA,KADD,CAAP;AAED,GAnCmC;;AAqCpC;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACEO,EAAAA,WA9CoC,uBA8CxBR,GA9CwB,EA8CnBS,UA9CmB,EA8CPP,OA9CO,EA8CE;AACpC,WAAO,KAAKC,MAAL,CAAYH,GAAZ,EAAiBE,OAAjB,EACJV,IADI,CACC,UAACY,CAAD;AAAA,aAAOM,kBAAKC,GAAL,CACVC,aADU,CACIR,CAAC,CAACG,GADN,EAEVT,OAFU,CAEFW,UAFE,EAGVjB,IAHU,CAGL,UAACqB,MAAD;AAAA,eAAYA,MAAM,CAACC,SAAP,CAAiBC,QAAjB,EAAZ;AAAA,OAHK,CAAP;AAAA,KADD,CAAP;AAKD,GApDmC;;AAsDpC;AACF;AACA;AACA;AACA;AACA;AACA;AACEC,EAAAA,QA7DoC,oBA6D3B1B,GA7D2B,EA6DtBY,OA7DsB,EA6Db;AAAA;;AACrB;AACA,QAAI,CAACZ,GAAG,CAAC2B,GAAT,EAAc;AACZ,aAAO,iBAAQrB,MAAR,CAAe,IAAIC,KAAJ,CAAU,uBAAV,CAAf,CAAP;AACD;;AAED,QAAMqB,KAAK,GAAG,IAAIC,oBAAJ,EAAd;;AACA,QAAMC,OAAO,GAAG,KAAKC,iBAAL,CAAuB/B,GAAvB,EAA4BY,OAA5B,EACbV,IADa,CACR,UAAC8B,GAAD,EAAS;AACb,UAAMpB,OAAO,GAAG;AACdqB,QAAAA,MAAM,EAAE,KADM;AAEdD,QAAAA,GAAG,EAAHA,GAFc;AAGdE,QAAAA,YAAY,EAAE;AAHA,OAAhB;;AAMA,UAAMC,GAAG,GAAG,KAAI,CAACC,OAAL,CAAaxB,OAAb,CAAZ;;AAEA,kCAAe,UAAf,EAA2BA,OAAO,CAACc,QAAnC,EAA6CE,KAA7C;AAEA,aAAOO,GAAP;AACD,KAba,EAcbjC,IAda,CAcR,UAACmC,GAAD;AAAA,aAAS,KAAI,CAACtC,aAAL,CAAmBC,GAAnB,EAAwBqC,GAAG,CAACC,IAA5B,CAAT;AAAA,KAdQ,CAAhB;;AAgBA,6BAAYV,KAAZ,EAAmBE,OAAnB;AAEA,WAAOA,OAAP;AACD,GAvFmC;;AAyFpC;AACF;AACA;AACA;AACA;AACA;AACA;AACEC,EAAAA,iBAhGoC,6BAgGlB/B,GAhGkB,EAgGbY,OAhGa,EAgGJ;AAAA;;AAC9B,SAAK2B,MAAL,CAAYC,IAAZ,CAAiB,wDAAjB;;AAEA,QAAIC,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,YAAzB,IAAyC3C,GAAG,CAAC2B,GAAJ,CAAQiB,QAAR,CAAiB,WAAjB,CAA7C,EAA4E;AAC1E,WAAKL,MAAL,CAAYC,IAAZ,CAAiB,qFAAjB;AAEA,aAAO,iBAAQK,OAAR,CAAgB7C,GAAG,CAAC2B,GAApB,CAAP;AACD;;AAED,QAAMmB,SAAS,GAAG;AAChBC,MAAAA,SAAS,EAAE,CAAC/C,GAAG,CAAC2B,GAAL;AADK,KAAlB;;AAGA,QAAMqB,WAAW,GAAGC,aAAIC,KAAJ,CAAUlD,GAAG,CAAC2B,GAAd,CAApB,CAZ8B,CAc9B;;;AACAqB,IAAAA,WAAW,CAACG,QAAZ,GAAuB,OAAvB;AACAH,IAAAA,WAAW,CAACI,QAAZ,GAAuB,wBAAvB;AAEA,WAAO,KAAKhB,OAAL,CAAa;AAClBH,MAAAA,MAAM,EAAE,MADU;AAElBD,MAAAA,GAAG,EAAEiB,aAAII,MAAJ,CAAWL,WAAX,CAFa;AAGlBV,MAAAA,IAAI,EAAE1B,OAAO,mCACRkC,SADQ;AAEXQ,QAAAA,KAAK,EAAE1C,OAAO,CAAC2C,MAAR,CAAeD;AAFX,WAGTR;AANc,KAAb,EAQJ5C,IARI,CAQC,UAACmC,GAAD,EAAS;AACb,UAAMY,GAAG,GAAGZ,GAAG,CAACC,IAAJ,CAASS,SAAT,CAAmB/C,GAAG,CAAC2B,GAAvB,CAAZ;;AAEA,UAAI,CAACsB,GAAL,EAAU;AACR,QAAA,MAAI,CAACV,MAAL,CAAYiB,IAAZ,CAAiB,uGAAjB;;AAEA,eAAOxD,GAAG,CAAC2B,GAAX;AACD;;AACD,MAAA,MAAI,CAACY,MAAL,CAAYC,IAAZ,CAAiB,uDAAjB;;AAEA,aAAOS,GAAP;AACD,KAnBI,CAAP;AAoBD,GAtImC;AAwIpCQ,EAAAA,aAxIoC,yBAwItBC,IAxIsB,EAwIhB;AAClB,WAAO,2BAAaA,IAAb,EACJxD,IADI,CACC,UAACD,MAAD;AAAA,aAAYc,iBAAI4C,MAAJ,GACfzD,IADe,CACV,UAACF,GAAD;AAAA,eAASA,GAAG,CAAC4D,OAAJ,CAAY3D,MAAZ,EACZC,IADY,CACP2D,qBADO,EAEb;AAFa,SAGZ3D,IAHY,CAGP,UAAC4D,KAAD;AAAA,iBAAY;AAAC9D,YAAAA,GAAG,EAAHA,GAAD;AAAM8D,YAAAA,KAAK,EAALA;AAAN,WAAZ;AAAA,SAHO,CAAT;AAAA,OADU,CAAZ;AAAA,KADD,CAAP;AAMD,GA/ImC;;AAiJpC;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACEC,EAAAA,UA1JoC,sBA0JzBrD,GA1JyB,EA0JpBV,GA1JoB,EA0JfY,OA1Je,EA0JN;AAC5B;AACA,QAAI,CAACZ,GAAG,CAAC2B,GAAT,EAAc;AACZ,aAAO,iBAAQrB,MAAR,CAAe,IAAIC,KAAJ,CAAU,kDAAV,CAAf,CAAP;AACD;;AAED,WAAO,KAAKM,MAAL,CAAYH,GAAZ,EAAiBE,OAAjB,EACJV,IADI,CACC,UAACY,CAAD;AAAA,aAAOd,GAAG,CAACgE,KAAJ,CAAUlD,CAAC,CAACG,GAAZ,CAAP;AAAA,KADD,CAAP;AAED,GAlKmC;;AAoKpC;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACEgD,EAAAA,WA7KoC,uBA6KxBvD,GA7KwB,EA6KnBc,SA7KmB,EA6KRZ,OA7KQ,EA6KC;AAAA;;AACnC,WAAO,KAAKC,MAAL,CAAYH,GAAZ,EAAiBE,OAAjB,EACJV,IADI,CACC,UAACY,CAAD;AAAA,aAAOM,kBAAKC,GAAL,CACV6C,aADU,CACI,MAAI,CAACC,MAAL,CAAYC,WADhB,EAC6B;AACtC1D,QAAAA,GAAG,EAAEI,CAAC,CAACG,GAD+B;AAEtCoD,QAAAA,MAAM,EAAE;AACNC,UAAAA,GAAG,EAAE;AADC,SAF8B;AAKtCC,QAAAA,SAAS,EAAE;AAL2B,OAD7B,EAQVC,KARU,CAQJhD,SARI,EAQO,MARP,CAAP;AAAA,KADD,CAAP;AAUD,GAxLmC;;AA0LpC;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACEX,EAAAA,MAlMoC,kBAkM7BmB,GAlM6B,EAkML;AAAA;;AAAA,mFAAJ,EAAI;AAAA,QAAlByC,UAAkB,QAAlBA,UAAkB;;AAC7B,QAAIzC,GAAG,CAACf,GAAR,EAAa;AACX,aAAO,KAAKvB,GAAL,CAASgF,KAAT,CAAe1C,GAAf,CAAP;AACD;;AAED,QAAI2C,UAAU,GAAG3C,GAAjB;;AAEA,QAAIyC,UAAJ,EAAgB;AACdE,MAAAA,UAAU,0BAAmBF,UAAnB,CAAV;AACD;;AAED,WAAO,KAAKG,gBAAL,CAAsBC,GAAtB,CAA0BF,UAA1B,EACJzE,IADI,CACC,UAAC4E,SAAD;AAAA,aAAeC,IAAI,CAAC7B,KAAL,CAAW4B,SAAX,CAAf;AAAA,KADD,EAEJ5E,IAFI,CAEC,UAAC8E,SAAD;AAAA,aAAe,MAAI,CAACtF,GAAL,CAASgF,KAAT,CAAeM,SAAf,CAAf;AAAA,KAFD,EAGJC,KAHI,CAGE;AAAA,aAAM,MAAI,CAACvF,GAAL,CAASwF,QAAT,CAAkB;AAAClD,QAAAA,GAAG,EAAHA,GAAD;AAAMyC,QAAAA,UAAU,EAAVA;AAAN,OAAlB,EACVvE,IADU,CACL,iBAAI,UAACQ,GAAD;AAAA,eAAS,MAAI,CAACkE,gBAAL,CAAsBO,GAAtB,CAA0BR,UAA1B,EAAsC,wBAAejE,GAAf,EAAoB0E,QAApB,CAAtC,CAAT;AAAA,OAAJ,CADK,CAAN;AAAA,KAHF,CAAP;AAKD,GAlNmC;AAAA;AAAA,CAAnB,CAAnB;AAqNA;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASA,QAAT,CAAkBtE,CAAlB,EAAqBuE,CAArB,EAAwB;AACtB,MAAIvE,CAAC,KAAK,KAAV,EAAiB;AACf;AACA;AACA,QAAMwE,IAAI,GAAG,KAAKxE,CAAL,EAAQyE,MAAR,CAAe,IAAf,CAAb;AAEA,WAAOD,IAAP;AACD;;AAED,SAAOD,CAAP;AACD;;eAEc/F,U","sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {EventEmitter} from 'events';\nimport url from 'url';\n\nimport {WebexPlugin} from '@webex/webex-core';\nimport {proxyEvents, tap, transferEvents} from '@webex/common';\nimport jose from 'node-jose';\nimport SCR from 'node-scr';\n\nimport ensureBuffer from './ensure-buffer';\nimport KMS from './kms';\n\nconst Encryption = WebexPlugin.extend({\n  children: {\n    kms: KMS\n  },\n\n  namespace: 'Encryption',\n\n  processKmsMessageEvent(event) {\n    return this.kms.processKmsMessageEvent(event);\n  },\n\n  decryptBinary(scr, buffer) {\n    return ensureBuffer(buffer)\n      .then((b) => {\n        /* istanbul ignore if */\n        if (buffer.length === 0 || buffer.byteLength === 0) {\n          return Promise.reject(new Error('Attempted to decrypt zero-length buffer'));\n        }\n\n        return scr.decrypt(b);\n      });\n  },\n\n  /**\n   * Decrypt a SCR (Secure Content Resource) using the supplied key uri.\n   *\n   * @param {string} key - The uri of a key stored in KMS\n   * @param {Object} cipherScr - An encrypted SCR\n   * @param {Object} options\n   * @param {string} options.onBehalfOf - Fetch the KMS key on behalf of another user (using the user's UUID), active user requires the 'spark.kms_orgagent' role\n   * @returns {Object} Decrypted SCR\n   */\n  decryptScr(key, cipherScr, options) {\n    return this.getKey(key, options)\n      .then((k) => SCR.fromJWE(k.jwk, cipherScr));\n  },\n\n  /**\n   * Decrypt text using the supplied key uri.\n   *\n   * @param {string} key - The uri of a key stored in KMS\n   * @param {string} ciphertext - Encrypted text\n   * @param {Object} options\n   * @param {string} options.onBehalfOf - Fetch the KMS key on behalf of another user (using the user's UUID), active user requires the 'spark.kms_orgagent' role\n   * @returns {string} Decrypted plaintext\n   */\n  decryptText(key, ciphertext, options) {\n    return this.getKey(key, options)\n      .then((k) => jose.JWE\n        .createDecrypt(k.jwk)\n        .decrypt(ciphertext)\n        .then((result) => result.plaintext.toString()));\n  },\n\n  /**\n   * Validate and initiate a Download request for requested file\n   *\n   * @param {Object} scr - Plaintext\n   * @param {Object} options - optional paramaters to download a file\n   * @returns {promise}\n   */\n  download(scr, options) {\n    /* istanbul ignore if */\n    if (!scr.loc) {\n      return Promise.reject(new Error('`scr.loc` is required'));\n    }\n\n    const shunt = new EventEmitter();\n    const promise = this._fetchDownloadUrl(scr, options)\n      .then((uri) => {\n        const options = {\n          method: 'GET',\n          uri,\n          responseType: 'buffer'\n        };\n\n        const ret = this.request(options);\n\n        transferEvents('progress', options.download, shunt);\n\n        return ret;\n      })\n      .then((res) => this.decryptBinary(scr, res.body));\n\n    proxyEvents(shunt, promise);\n\n    return promise;\n  },\n\n  /**\n   * Fetch Download URL for the requested file\n   *\n   * @param {Object} scr - Plaintext\n   * @param {Object} options - optional paramaters to download a file\n   * @returns {promise} url of the downloadable file\n   */\n  _fetchDownloadUrl(scr, options) {\n    this.logger.info('encryption: retrieving download url for encrypted file');\n\n    if (process.env.NODE_ENV !== 'production' && scr.loc.includes('localhost')) {\n      this.logger.info('encryption: bypassing webex files because this looks to be a test file on localhost');\n\n      return Promise.resolve(scr.loc);\n    }\n\n    const inputBody = {\n      endpoints: [scr.loc]\n    };\n    const endpointUrl = url.parse(scr.loc);\n\n    // hardcode the url to use 'https' and the file service '/v1/download/endpoints' api\n    endpointUrl.protocol = 'https';\n    endpointUrl.pathname = '/v1/download/endpoints';\n\n    return this.request({\n      method: 'POST',\n      uri: url.format(endpointUrl),\n      body: options ? {\n        ...inputBody,\n        allow: options.params.allow\n      } : inputBody\n    })\n      .then((res) => {\n        const url = res.body.endpoints[scr.loc];\n\n        if (!url) {\n          this.logger.warn('encryption: could not determine download url for `scr.loc`; attempting to download `scr.loc` directly');\n\n          return scr.loc;\n        }\n        this.logger.info('encryption: retrieved download url for encrypted file');\n\n        return url;\n      });\n  },\n\n  encryptBinary(file) {\n    return ensureBuffer(file)\n      .then((buffer) => SCR.create()\n        .then((scr) => scr.encrypt(buffer)\n          .then(ensureBuffer)\n          // eslint-disable-next-line max-nested-callbacks\n          .then((cdata) => ({scr, cdata}))));\n  },\n\n  /**\n   * Encrypt a SCR (Secure Content Resource) using the supplied key uri.\n   *\n   * @param {string} key - The uri of a key stored in KMS\n   * @param {Object} scr - Plaintext\n   * @param {Object} options\n   * @param {string} options.onBehalfOf - Fetch the KMS key on behalf of another user (using the user's UUID), active user requires the 'spark.kms_orgagent' role\n   * @returns {string} Encrypted SCR\n   */\n  encryptScr(key, scr, options) {\n    /* istanbul ignore if */\n    if (!scr.loc) {\n      return Promise.reject(new Error('Cannot encrypt `scr` without first setting `loc`'));\n    }\n\n    return this.getKey(key, options)\n      .then((k) => scr.toJWE(k.jwk));\n  },\n\n  /**\n   * Encrypt plaintext using the supplied key uri.\n   *\n   * @param {string} key - The uri of a key stored in KMS\n   * @param {string} plaintext\n   * @param {Object} options\n   * @param {string} options.onBehalfOf - Fetch the KMS key on behalf of another user (using the user's UUID), active user requires the 'spark.kms_orgagent' role\n   * @returns {string} Encrypted text\n   */\n  encryptText(key, plaintext, options) {\n    return this.getKey(key, options)\n      .then((k) => jose.JWE\n        .createEncrypt(this.config.joseOptions, {\n          key: k.jwk,\n          header: {\n            alg: 'dir'\n          },\n          reference: null\n        })\n        .final(plaintext, 'utf8'));\n  },\n\n  /**\n   * Fetch the key associated with the supplied KMS uri.\n   *\n   * @param {string} uri - The uri of a key stored in KMS\n   * @param {Object} options\n   * @param {string} options.onBehalfOf - Fetch the KMS key on behalf of another user (using the user's UUID), active user requires the 'spark.kms_orgagent' role\n   * @returns {string} Key\n   */\n  getKey(uri, {onBehalfOf} = {}) {\n    if (uri.jwk) {\n      return this.kms.asKey(uri);\n    }\n\n    let storageKey = uri;\n\n    if (onBehalfOf) {\n      storageKey += `/onBehalfOf/${onBehalfOf}`;\n    }\n\n    return this.unboundedStorage.get(storageKey)\n      .then((keyString) => JSON.parse(keyString))\n      .then((keyObject) => this.kms.asKey(keyObject))\n      .catch(() => this.kms.fetchKey({uri, onBehalfOf})\n        .then(tap((key) => this.unboundedStorage.put(storageKey, JSON.stringify(key, replacer)))));\n  }\n});\n\n/**\n * JSON.stringify replacer that ensures private key data is serialized.\n * @param {string} k\n * @param {mixed} v\n * @returns {mixed}\n */\nfunction replacer(k, v) {\n  if (k === 'jwk') {\n    // note: this[k] and v may be different representations of the same value\n    // eslint-disable-next-line no-invalid-this\n    const json = this[k].toJSON(true);\n\n    return json;\n  }\n\n  return v;\n}\n\nexport default Encryption;\n"]}