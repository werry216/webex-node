{"version":3,"sources":["index.js"],"names":["require","Buffer","parse","updateImageOrientation","file","options","resolve","reader","FileReader","readAsArrayBuffer","onload","arrayBuffer","result","buf","from","then","shouldNotAddExifData","readExifData","type","mimeType","translateValues","exifData","Orientation","ExifImageHeight","ExifImageWidth","orientation","exifHeight","exifWidth","image","orient","width","height","ctx","img","x","y","transform","drawImage"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAwHA;;AACA;;AAzHA;AACA;AACA;;AAEA;;AACA;eAEiBA,OAAO,CAAC,aAAD,C;IAAjBC,M,YAAAA,M;;gBACSD,OAAO,CAAC,qBAAD,C;IAAhBE,K,aAAAA,K;AAEP;AACA;AACA;AACA;AACA;AACA;AACA;;;AACO,SAASC,sBAAT,CAAgCC,IAAhC,EAAoD;AAAA,MAAdC,OAAc,uEAAJ,EAAI;AACzD,SAAO,qBAAY,UAACC,OAAD,EAAa;AAC9B,QAAMC,MAAM,GAAG,IAAIC,UAAJ,EAAf;AAEAD,IAAAA,MAAM,CAACE,iBAAP,CAAyBL,IAAzB;;AACAG,IAAAA,MAAM,CAACG,MAAP,GAAgB,SAASA,MAAT,GAAkB;AAChC,UAAMC,WAAW,GAAGJ,MAAM,CAACK,MAA3B;AACA,UAAMC,GAAG,GAAGZ,MAAM,CAACa,IAAP,CAAYH,WAAZ,CAAZ;AAEAL,MAAAA,OAAO,CAACO,GAAD,CAAP;AACD,KALD;AAMD,GAVM,EAWJE,IAXI,CAWC,UAACF,GAAD,EAAS;AACb,QAAIR,OAAO,CAACW,oBAAZ,EAAkC;AAChC,aAAOH,GAAP;AACD;;AAED,WAAOI,YAAY,CAACb,IAAD,EAAOS,GAAP,CAAnB;AACD,GAjBI,CAAP;AAkBD;AAED;AACA;AACA;AACA;AACA;AACA;;;SACsBI,Y;;;AAwBtB;;AACA;AACA;AACA;AACA;AACA;AACA;;;;0FA9BO,iBAA4Bb,IAA5B,EAAkCS,GAAlC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAGHT,IAAI,KACHA,IAAI,CAACc,IAAL,KAAc,YAAd,IAA8Bd,IAAI,CAACe,QAAL,KAAkB,YAD7C,CAHD;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAMoBjB,KAAK,CAACW,GAAD,EAAM;AAACO,cAAAA,eAAe,EAAE;AAAlB,aAAN,CANzB;;AAAA;AAMGC,YAAAA,QANH;;AAQH,gBAAIA,QAAJ,EAAc;AACLC,cAAAA,WADK,GAC2CD,QAD3C,CACLC,WADK,EACQC,eADR,GAC2CF,QAD3C,CACQE,eADR,EACyBC,cADzB,GAC2CH,QAD3C,CACyBG,cADzB;AAGZpB,cAAAA,IAAI,CAACqB,WAAL,GAAmBH,WAAnB;AACAlB,cAAAA,IAAI,CAACsB,UAAL,GAAkBH,eAAlB;AACAnB,cAAAA,IAAI,CAACuB,SAAL,GAAiBH,cAAjB;;AAEA,kBAAIpB,IAAI,CAACwB,KAAT,EAAgB;AACdxB,gBAAAA,IAAI,CAACwB,KAAL,CAAWH,WAAX,GAAyBH,WAAzB;AACD;AACF;;AAlBE;AAAA,6CAqBET,GArBF;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AA+BA,SAASgB,MAAT,CAAgBxB,OAAhB,EAAyBD,IAAzB,EAA+B;AAAA,MAElC0B,KAFkC,GAGhCzB,OAHgC,CAElCyB,KAFkC;AAAA,MAE3BC,MAF2B,GAGhC1B,OAHgC,CAE3B0B,MAF2B;AAAA,MAEnBC,GAFmB,GAGhC3B,OAHgC,CAEnB2B,GAFmB;AAAA,MAEdC,GAFc,GAGhC5B,OAHgC,CAEd4B,GAFc;AAAA,MAETR,WAFS,GAGhCpB,OAHgC,CAEToB,WAFS;AAAA,MAEIS,CAFJ,GAGhC7B,OAHgC,CAEI6B,CAFJ;AAAA,MAEOC,CAFP,GAGhC9B,OAHgC,CAEO8B,CAFP;;AAKpC,MAAI/B,IAAI,IAAIA,IAAI,CAACqB,WAAb,IAA4BrB,IAAI,CAACqB,WAAL,KAAqB,CAArD,EAAwD;AACtD;AACA;AACA,YAAQA,WAAR;AACE,WAAK,CAAL;AACE;AACAO,QAAAA,GAAG,CAACI,SAAJ,CAAc,CAAC,CAAf,EAAkB,CAAlB,EAAqB,CAArB,EAAwB,CAAxB,EAA2BN,KAA3B,EAAkC,CAAlC;AACA;;AACF,WAAK,CAAL;AACA;AACEE,QAAAA,GAAG,CAACI,SAAJ,CAAc,CAAC,CAAf,EAAkB,CAAlB,EAAqB,CAArB,EAAwB,CAAC,CAAzB,EAA4BN,KAA5B,EAAmCC,MAAnC;AACA;;AACF,WAAK,CAAL;AACA;AACEC,QAAAA,GAAG,CAACI,SAAJ,CAAc,CAAd,EAAiB,CAAjB,EAAoB,CAApB,EAAuB,CAAC,CAAxB,EAA2B,CAA3B,EAA8BL,MAA9B;AACA;;AACF,WAAK,CAAL;AACA;AACEC,QAAAA,GAAG,CAACI,SAAJ,CAAc,CAAd,EAAiB,CAAjB,EAAoB,CAApB,EAAuB,CAAvB,EAA0B,CAA1B,EAA6B,CAA7B;AACA;;AACF,WAAK,CAAL;AACA;AACEJ,QAAAA,GAAG,CAACI,SAAJ,CAAc,CAAd,EAAiB,CAAjB,EAAoB,CAAC,CAArB,EAAwB,CAAxB,EAA2BL,MAA3B,EAAmC,CAAnC;AACA;;AACF,WAAK,CAAL;AACA;AACEC,QAAAA,GAAG,CAACI,SAAJ,CAAc,CAAd,EAAiB,CAAC,CAAlB,EAAqB,CAAC,CAAtB,EAAyB,CAAzB,EAA4BL,MAA5B,EAAoCD,KAApC;AACA;;AACF,WAAK,CAAL;AACA;AACEE,QAAAA,GAAG,CAACI,SAAJ,CAAc,CAAd,EAAiB,CAAC,CAAlB,EAAqB,CAArB,EAAwB,CAAxB,EAA2B,CAA3B,EAA8BN,KAA9B;AACA;;AACF;AACE;AA9BJ;AAgCD;;AACDE,EAAAA,GAAG,CAACK,SAAJ,CAAcJ,GAAd,EAAmBC,CAAnB,EAAsBC,CAAtB,EAAyBL,KAAzB,EAAgCC,MAAhC;AACD;AACD","sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\n/* eslint no-unused-vars: [\"error\", { \"vars\": \"local\" }] */\n/* global Uint8Array, FileReader */\n\nconst {Buffer} = require('safe-buffer');\nconst {parse} = require('exifr/dist/lite.umd');\n\n/**\n* Updates the image file with exif information, required to correctly rotate the image activity\n* @param {Object} file\n* @param {Object} options\n* @param {boolean} options.shouldNotAddExifData\n* @returns {Promise<Object>}\n*/\nexport function updateImageOrientation(file, options = {}) {\n  return new Promise((resolve) => {\n    const reader = new FileReader();\n\n    reader.readAsArrayBuffer(file);\n    reader.onload = function onload() {\n      const arrayBuffer = reader.result;\n      const buf = Buffer.from(arrayBuffer);\n\n      resolve(buf);\n    };\n  })\n    .then((buf) => {\n      if (options.shouldNotAddExifData) {\n        return buf;\n      }\n\n      return readExifData(file, buf);\n    });\n}\n\n/**\n* Adds exif orientation information on the image file\n* @param {Object} file\n* @param {Object} buf\n* @returns {Promise<ExifImage>}\n*/\nexport async function readExifData(file, buf) {\n  // For avatar images the file.type is set as image/jpeg, however for images shared in an activity file.mimeType is set as image/jpeg. Handling both conditions.\n  if (\n    file &&\n    (file.type === 'image/jpeg' || file.mimeType === 'image/jpeg')\n  ) {\n    const exifData = await parse(buf, {translateValues: false});\n\n    if (exifData) {\n      const {Orientation, ExifImageHeight, ExifImageWidth} = exifData;\n\n      file.orientation = Orientation;\n      file.exifHeight = ExifImageHeight;\n      file.exifWidth = ExifImageWidth;\n\n      if (file.image) {\n        file.image.orientation = Orientation;\n      }\n    }\n  }\n\n  return buf;\n}\n\n/* eslint-disable complexity */\n/**\n* Rotates/flips the image on the canvas as per exif information\n* @param {Object} options(orientation: image exif orientation range from 1-8, img: Image object, x: start x-axis, y: start y-axis, width: width of the thumbnail, height: height of the thumbnail, ctx: canvas context)\n* @param {Object} file\n* @returns {Object}\n*/\nexport function orient(options, file) {\n  const {\n    width, height, ctx, img, orientation, x, y\n  } = options;\n\n  if (file && file.orientation && file.orientation !== 1) {\n    // explanation of orientation:\n    // https://stackoverflow.com/questions/20600800/js-client-side-exif-orientation-rotate-and-mirror-jpeg-images\n    switch (orientation) {\n      case 2:\n        // flip\n        ctx.transform(-1, 0, 0, 1, width, 0);\n        break;\n      case 3:\n      // rotateImage180\n        ctx.transform(-1, 0, 0, -1, width, height);\n        break;\n      case 4:\n      // rotate180AndFlipImage\n        ctx.transform(1, 0, 0, -1, 0, height);\n        break;\n      case 5:\n      // rotate90AndFlipImage\n        ctx.transform(0, 1, 1, 0, 0, 0);\n        break;\n      case 6:\n      // rotateImage90\n        ctx.transform(0, 1, -1, 0, height, 0);\n        break;\n      case 7:\n      // rotateNeg90AndFlipImage\n        ctx.transform(0, -1, -1, 0, height, width);\n        break;\n      case 8:\n      // rotateNeg90\n        ctx.transform(0, -1, 1, 0, 0, width);\n        break;\n      default:\n        break;\n    }\n  }\n  ctx.drawImage(img, x, y, width, height);\n}\n/* eslint-enable complexity */\n\nexport {default as processImage} from './process-image';\nexport {default as detectFileType} from './detect-filetype';\n"]}