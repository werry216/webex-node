{"version":3,"sources":["process-image.browser.js"],"names":["computeDimensions","maxWidth","maxHeight","width","height","processImage","file","type","thumbnailMaxWidth","thumbnailMaxHeight","enableThumbnails","logger","isAvatar","startsWith","resolve","Blob","reject","img","Image","onload","onerror","src","URL","createObjectURL","then","fileDimensions","info","size","thumbnailDimensions","canvas","document","createElement","ctx","getContext","orientation","x","y","parts","toDataURL","split","byteString","atob","buffer","ArrayBuffer","length","view","DataView","i","setUint8","charCodeAt"],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {pick} from 'lodash';\n\nimport {orient} from './index';\n/* eslint-env browser */\n\n/**\n * Determins the dimensions of an image\n * @param {Object} constraints\n * @param {Number} constraints.width\n * @param {Number} constraints.height\n * @param {Number} maxWidth\n * @param {Number} maxHeight\n * @returns {Object}\n */\nfunction computeDimensions({width, height}, maxWidth, maxHeight) {\n  if (height > width) {\n    if (height > maxHeight) {\n      width = width * maxHeight / height;\n      height = maxHeight;\n    }\n\n    if (width > maxWidth) {\n      height = height * maxWidth / width;\n      width = maxWidth;\n    }\n  }\n  else {\n    if (width > maxWidth) {\n      height = height * maxWidth / width;\n      width = maxWidth;\n    }\n\n    if (height > maxHeight) {\n      width = width * maxHeight / height;\n      height = maxHeight;\n    }\n  }\n\n  return {height, width};\n}\n\n/**\n * Measures an image file and produces a thumbnail for it\n * @param {Object} options\n * @param {Blob|ArrayBuffer} options.file\n * @param {Number} options.thumbnailMaxWidth\n * @param {Number} options.thumbnailMaxHeight\n * @param {Boolean} options.enableThumbnails\n * @param {Object} options.logger\n * @param {Boolean} options.isAvatar\n * @returns {Promise<Array>} Buffer, Dimensions, thumbnailDimensions\n */\nexport default function processImage({\n  file, type, thumbnailMaxWidth, thumbnailMaxHeight, enableThumbnails, logger, isAvatar\n}) {\n  if (!type || !type.startsWith('image')) {\n    return Promise.resolve();\n  }\n\n  file = file instanceof Blob ? file : new Blob([file]);\n\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n\n    img.onload = function onload() {\n      resolve(img);\n    };\n    img.onerror = reject;\n    img.src = URL.createObjectURL(file);\n  })\n    .then((img) => {\n      const fileDimensions = pick(img, 'height', 'width');\n\n      if (isAvatar) { // only if image is a profile avatar\n        logger.info('dimensions will be set for avatar image');\n        const size = fileDimensions.height > fileDimensions.width ? fileDimensions.height : fileDimensions.width;\n\n        fileDimensions.height = size;\n        fileDimensions.width = size;\n      }\n      if (!enableThumbnails) {\n        logger.info('thumbnails not enabled');\n\n        return [null, fileDimensions, null];\n      }\n      const thumbnailDimensions = computeDimensions(fileDimensions, thumbnailMaxWidth, thumbnailMaxHeight);\n\n      const canvas = document.createElement('canvas');\n      const ctx = canvas.getContext('2d');\n      const {width, height} = thumbnailDimensions;\n\n      // explanation of orientation:\n      // https://stackoverflow.com/questions/20600800/js-client-side-exif-orientation-rotate-and-mirror-jpeg-images\n      if (file.orientation && file.orientation > 4) {\n        canvas.width = height;\n        canvas.height = width;\n        thumbnailDimensions.width = height;\n        thumbnailDimensions.height = width;\n      }\n      else {\n        canvas.width = thumbnailDimensions.width;\n        canvas.height = thumbnailDimensions.height;\n      }\n\n\n      orient(\n        {\n          orientation: file && file.orientation ? file.orientation : '',\n          img,\n          x: 0,\n          y: 0,\n          width,\n          height,\n          ctx\n        },\n        file\n      );\n\n      const parts = canvas.toDataURL('image/png').split(',');\n      // Thumbnail uploads were failing with common/base64 decoding\n      const byteString = atob(parts[1]);\n\n      const buffer = new ArrayBuffer(byteString.length);\n      const view = new DataView(buffer);\n\n      for (let i = 0; i < byteString.length; i += 1) {\n        view.setUint8(i, byteString.charCodeAt(i));\n      }\n\n      return [buffer, fileDimensions, thumbnailDimensions];\n    });\n}\n"]}