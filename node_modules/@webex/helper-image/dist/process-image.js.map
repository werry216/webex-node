{"version":3,"sources":["process-image.js"],"names":["processImage","file","type","thumbnailMaxWidth","thumbnailMaxHeight","enableThumbnails","logger","fileType","startsWith","resolve","fileDimensions","reject","size","err","thumbnail","thumbnailDimensions","resize","autoOrient","toBuffer","buffer","then","all","catch","errorString","toString","includes","warn","debug"],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport gm from 'gm';\nimport {pick} from 'lodash';\n\n/**\n * Measures an image file and produces a thumbnail for it\n * @param {Object} options\n * @param {Blob|ArrayBuffer} options.file\n * @param {Number} options.thumbnailMaxWidth\n * @param {Number} options.thumbnailMaxHeight\n * @param {Boolean} options.enableThumbnails\n * @param {Object} options.logger\n * @returns {Promise<Array>} Buffer, Dimensions, thumbnailDimensions\n */\nexport default function processImage({\n  file, type, thumbnailMaxWidth, thumbnailMaxHeight, enableThumbnails, logger\n}) {\n  const fileType = type || file.type;\n\n  if (!fileType || !fileType.startsWith('image')) {\n    return Promise.resolve();\n  }\n\n  const fileDimensions = new Promise((resolve, reject) => {\n    gm(file).size((err, size) => {\n      if (err) {\n        reject(err);\n\n        return;\n      }\n\n      resolve(pick(size, 'width', 'height'));\n    });\n  });\n\n  let thumbnail, thumbnailDimensions;\n\n  if (enableThumbnails) {\n    thumbnail = new Promise((resolve, reject) => {\n      gm(file).resize(thumbnailMaxWidth, thumbnailMaxHeight)\n        .autoOrient()\n        .toBuffer('PNG', (err, buffer) => {\n          if (err) {\n            reject(err);\n\n            return;\n          }\n\n          resolve(buffer);\n        });\n    });\n\n    thumbnailDimensions = thumbnail.then((buffer) => new Promise((resolve, reject) => {\n      gm(buffer)\n        .size((err, size) => {\n          if (err) {\n            reject(err);\n\n            return;\n          }\n\n          resolve(pick(size, 'width', 'height'));\n        });\n    }));\n  }\n\n\n  return Promise.all([thumbnail, fileDimensions, thumbnailDimensions])\n    .catch((err) => {\n      const errorString = err.toString();\n\n      if (errorString.includes('EPIPE')) {\n        logger.warn(err, 'Is GraphicsMagick installed?');\n\n        return Promise.resolve();\n      }\n\n      if (errorString.includes('No decode delegate for this image format')) {\n        logger.debug(err, 'File does not appear to be an image');\n\n        return Promise.resolve();\n      }\n\n      if (errorString.includes('Stream yields empty buffer')) {\n        logger.debug(err, 'File does not appear to be an image');\n\n        return Promise.resolve();\n      }\n\n      return Promise.reject(err);\n    });\n}\n"]}